name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Verify GitHub Secrets
      env:
        CERT_BASE64: ${{ secrets.CODE_SIGNING_CERT }}
        CERT_PASSWORD: ${{ secrets.CODE_SIGNING_PASSWORD }}
      run: |
        Write-Host "=== Secret Verification ===" -ForegroundColor Cyan
        if ([string]::IsNullOrEmpty($env:CERT_BASE64)) {
          Write-Error "CODE_SIGNING_CERT secret not found!"
          Write-Host "Please set: Settings -> Secrets and variables -> Actions"
          exit 1
        }
        Write-Host "[OK] CODE_SIGNING_CERT found" -ForegroundColor Green
        
        if ([string]::IsNullOrEmpty($env:CERT_PASSWORD)) {
          Write-Error "CODE_SIGNING_PASSWORD secret not found!"
          exit 1
        }
        Write-Host "[OK] CODE_SIGNING_PASSWORD found" -ForegroundColor Green
        Write-Host ""
      shell: pwsh
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install NSIS
      run: |
        choco install nsis -y
        
    - name: Decode certificate
      env:
        CERT_BASE64: ${{ secrets.CODE_SIGNING_CERT }}
      run: |
        Write-Host "Decoding certificate from Base64..." -ForegroundColor Gray
        try {
          $certBytes = [System.Convert]::FromBase64String($env:CERT_BASE64)
          [System.IO.File]::WriteAllBytes("CodeSigningCert.pfx", $certBytes)
          $fileSize = (Get-Item CodeSigningCert.pfx).Length
          Write-Host "âœ“ Certificate decoded: CodeSigningCert.pfx ($fileSize bytes)" -ForegroundColor Green
        } catch {
          Write-Error "Failed to decode Base64: $($_.Exception.Message)"
          exit 1
        }
      shell: pwsh
      
    - name: Verify certificate password
      env:
        CERT_PASSWORD: ${{ secrets.CODE_SIGNING_PASSWORD }}
      run: |
        Write-Host "Verifying certificate..." -ForegroundColor Gray
        try {
          $cert = New-Object System.Security.Cryptography.X509Certificates.X509Certificate2("CodeSigningCert.pfx", $env:CERT_PASSWORD)
          Write-Host "âœ“ Certificate loaded successfully" -ForegroundColor Green
          Write-Host "  Subject: $($cert.Subject)" -ForegroundColor Gray
          Write-Host "  Expires: $($cert.NotAfter)" -ForegroundColor Gray
        } catch {
          Write-Error "Failed to load certificate: $($_.Exception.Message)"
          Write-Host "  Possible causes:" -ForegroundColor Yellow
          Write-Host "    - CODE_SIGNING_PASSWORD is incorrect"
          Write-Host "    - Certificate file is corrupted"
          exit 1
        }
      shell: pwsh
      
    - name: Extract version from config.py
      id: version
      run: |
        $versionMatch = Select-String -Path "config.py" -Pattern 'APP_VERSION\s*=\s*"([^"]+)"'
        $appVersion = $versionMatch.Matches.Groups[1].Value
        echo "APP_VERSION=$appVersion" >> $env:GITHUB_OUTPUT
        Write-Host "Version: $appVersion" -ForegroundColor Green
      shell: pwsh
        
    - name: Build with PyInstaller
      run: |
        Write-Host "Building executable..." -ForegroundColor Cyan
        python -m PyInstaller my_notepad_app.spec --clean
      
    - name: Verify build output
      run: |
        Write-Host "Build verification:" -ForegroundColor Cyan
        $exePath = "dist\Pro-Multi-Tab-Notepad.exe"
        if (Test-Path $exePath) {
          $file = Get-Item $exePath
          Write-Host "âœ“ $exePath found ($([math]::Round($file.Length/1MB, 2)) MB)" -ForegroundColor Green
        } else {
          Write-Host "âœ— File not found: $exePath" -ForegroundColor Red
          Write-Host "Available files:" -ForegroundColor Yellow
          Get-ChildItem "dist" -Filter "*.exe" 2>$null | ForEach-Object { Write-Host "  - $($_.Name)" }
          exit 1
        }
      shell: pwsh
      
    - name: Sign executable
      env:
        CERT_PASSWORD: ${{ secrets.CODE_SIGNING_PASSWORD }}
      run: |
        Write-Host "Signing executable..." -ForegroundColor Cyan
        .\sign_executable.ps1 -ExePath "dist\Pro-Multi-Tab-Notepad.exe" -CertPath "CodeSigningCert.pfx" -CertPassword "$env:CERT_PASSWORD"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Signing failed!"
          exit 1
        }
      shell: pwsh
        
    - name: Build NSIS installer
      run: |
        Write-Host "Building installer..." -ForegroundColor Cyan
        $appVersion = "${{ steps.version.outputs.APP_VERSION }}"
        & "C:\Program Files (x86)\NSIS\makensis.exe" /DAPP_VERSION=$appVersion installer.nsi
        if ($LASTEXITCODE -ne 0) {
          Write-Error "NSIS build failed!"
          exit 1
        }
      shell: pwsh
      
    - name: Verify installer file
      run: |
        $appVersion = "${{ steps.version.outputs.APP_VERSION }}"
        $installerPath = "Pro-Multi-Tab-Notepad-Installer-v$appVersion.exe"
        if (Test-Path $installerPath) {
          $file = Get-Item $installerPath
          Write-Host "âœ“ Installer created ($([math]::Round($file.Length/1MB, 2)) MB)" -ForegroundColor Green
        } else {
          Write-Error "Installer not found: $installerPath"
          exit 1
        }
      shell: pwsh
      
    - name: Sign installer
      env:
        CERT_PASSWORD: ${{ secrets.CODE_SIGNING_PASSWORD }}
      run: |
        Write-Host "Signing installer..." -ForegroundColor Cyan
        $appVersion = "${{ steps.version.outputs.APP_VERSION }}"
        $installerPath = "Pro-Multi-Tab-Notepad-Installer-v$appVersion.exe"
        .\sign_executable.ps1 -ExePath $installerPath -CertPath "CodeSigningCert.pfx" -CertPassword "$env:CERT_PASSWORD"
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Installer signing failed!"
          exit 1
        }
      shell: pwsh
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: Pro Multi-Tab Notepad ${{ github.ref_name }}
        body: |
          ## Pro Multi-Tab Notepad ${{ github.ref_name }}
          
          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ç‰ˆï¼ˆæ¨å¥¨ï¼‰**
          - Windows 64bit å‘ã‘ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼
          - ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£ä»˜ã‘è‡ªå‹•è¨­å®š
          - ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä½œæˆ
          
          **ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆ**
          - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€å˜ä½“ã§å‹•ä½œ
          - USB ãƒ¡ãƒ¢ãƒªãªã©ã§æŒã¡é‹ã³å¯èƒ½
          
          ### âœ¨ ä¸»ãªæ©Ÿèƒ½
          - ãƒãƒ«ãƒã‚¿ãƒ–ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿
          - Markdown ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆLaTeXãƒ»åŒ–å­¦å¼å¯¾å¿œï¼‰
          - ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          - ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ãƒ»ç½®æ›
          - å¤šè¨€èªå¯¾å¿œï¼ˆæ—¥æœ¬èªãƒ»è‹±èªï¼‰
          
          ### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åæ¸ˆã¿
          - ç™ºè¡Œè€…: EnoMi-4mg, Personal
        
        files: |
          dist/Pro-Multi-Tab-Notepad.exe
          Pro-Multi-Tab-Notepad-Installer-v${{ steps.version.outputs.APP_VERSION }}.exe
        
    - name: Cleanup
      if: always()
      run: |
        if (Test-Path "CodeSigningCert.pfx") {
          Remove-Item "CodeSigningCert.pfx" -Force
          Write-Host "âœ“ Certificate cleaned up" -ForegroundColor Green
        }
      shell: pwsh
