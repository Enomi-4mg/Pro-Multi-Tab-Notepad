name: Build and Release

on:
  push:
    tags:
      - 'v*'  # v1.6.2, v1.7.0 ãªã©ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Install NSIS
      run: |
        choco install nsis -y
        
    - name: Decode certificate
      run: |
        $certBase64 = "${{ secrets.CERT_BASE64 }}"
        $certBytes = [System.Convert]::FromBase64String($certBase64)
        [System.IO.File]::WriteAllBytes("CodeSigningCert.pfx", $certBytes)
      shell: pwsh
      
    - name: Extract version from config.py
      id: version
      run: |
        $versionMatch = Select-String -Path "config.py" -Pattern 'APP_VERSION\s*=\s*"([^"]+)"'
        $appVersion = $versionMatch.Matches.Groups[1].Value
        echo "APP_VERSION=$appVersion" >> $env:GITHUB_OUTPUT
        Write-Host "Extracted version: $appVersion"
      shell: pwsh
      
    - name: Build with PyInstaller
      run: |
        python -m PyInstaller my_notepad_app.spec --clean
      
    - name: Sign executable
      run: |
        $certPath = "CodeSigningCert.pfx"
        $exePath = "dist\Pro-Multi-Tab-Notepad.exe"
        $certPassword = "${{ secrets.CERT_PASSWORD }}"
        
        # signtool ã§EXEã«ç½²å
        & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign `
          /f $certPath `
          /p $certPassword `
          /fd SHA256 `
          /tr http://timestamp.digicert.com `
          /td SHA256 `
          /v `
          $exePath
      shell: pwsh
      
    - name: Build NSIS installer
      run: |
        $appVersion = "${{ steps.version.outputs.APP_VERSION }}"
        & "C:\Program Files (x86)\NSIS\makensis.exe" /DAPP_VERSION=$appVersion installer.nsi
      shell: pwsh
      
    - name: Sign installer
      run: |
        $certPath = "CodeSigningCert.pfx"
        $appVersion = "${{ steps.version.outputs.APP_VERSION }}"
        $installerPath = "Pro-Multi-Tab-Notepad-Installer-v$appVersion.exe"
        $certPassword = "${{ secrets.CERT_PASSWORD }}"
        
        # signtool ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ã«ç½²å
        & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign `
          /f $certPath `
          /p $certPassword `
          /fd SHA256 `
          /tr http://timestamp.digicert.com `
          /td SHA256 `
          /v `
          $installerPath
      shell: pwsh
      
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Pro Multi-Tab Notepad ${{ github.ref_name }}
        draft: false
        prerelease: false
        body: |
          ## Pro Multi-Tab Notepad ${{ github.ref_name }}
          
          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          
          **ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼ç‰ˆï¼ˆæ¨å¥¨ï¼‰**
          - Windows 64bit å‘ã‘ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ©ãƒ¼
          - ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£ä»˜ã‘è‡ªå‹•è¨­å®š
          - ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆä½œæˆ
          
          **ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ç‰ˆ**
          - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸è¦ã€å˜ä½“ã§å‹•ä½œ
          - USB ãƒ¡ãƒ¢ãƒªãªã©ã§æŒã¡é‹ã³å¯èƒ½
          
          ### âœ¨ ä¸»ãªæ©Ÿèƒ½
          - ãƒãƒ«ãƒã‚¿ãƒ–ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿
          - Markdown ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆLaTeXãƒ»åŒ–å­¦å¼å¯¾å¿œï¼‰
          - ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          - ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ãƒ»ç½®æ›
          - å¤šè¨€èªå¯¾å¿œï¼ˆæ—¥æœ¬èªãƒ»è‹±èªï¼‰
          
          ### ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
          - ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ã‚¸ã‚¿ãƒ«ç½²åæ¸ˆã¿
          - ç™ºè¡Œè€…: EnoMi-4mg, Personal
          
          ---
          
          è©³ç´°ã¯ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md) ã‚’ã”è¦§ãã ã•ã„ã€‚
        
    - name: Upload Installer to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./Pro-Multi-Tab-Notepad-Installer-v${{ steps.version.outputs.APP_VERSION }}.exe
        asset_name: Pro-Multi-Tab-Notepad-Installer-v${{ steps.version.outputs.APP_VERSION }}.exe
        asset_content_type: application/octet-stream
        
    - name: Upload Standalone EXE to Release
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./dist/Pro-Multi-Tab-Notepad.exe
        asset_name: Pro-Multi-Tab-Notepad-v${{ steps.version.outputs.APP_VERSION }}.exe
        asset_content_type: application/octet-stream
        
    - name: Cleanup certificate
      if: always()
      run: |
        if (Test-Path "CodeSigningCert.pfx") {
          Remove-Item "CodeSigningCert.pfx" -Force
        }
      shell: pwsh
